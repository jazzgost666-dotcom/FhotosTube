<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FhotosTube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 480px; background: #000; min-height: 100vh; position: relative; border-left: 1px solid #1a1a1a; border-right: 1px solid #1a1a1a; display: flex; flex-direction: column; }
        .screen { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.2s ease; }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .auth-input { background: #121212; border: 1px solid #333; color: white; padding: 15px; border-radius: 12px; width: 100%; margin-bottom: 12px; outline: none; }
        .btn-blue { background: #2563eb; color: white; font-weight: bold; padding: 14px; border-radius: 12px; width: 100%; cursor: pointer; }
        .grid-posts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
        .grid-item { aspect-ratio: 1/1; background: #111; overflow: hidden; border: 1px solid #000; }
        .grid-item img, .grid-item video { width: 100%; height: 100%; object-fit: cover; }
        nav { position: fixed; bottom: 0; width: 100%; max-width: 480px; background: #000; border-top: 1px solid #1a1a1a; height: 60px; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        video { background: #000; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="loginScreen" class="screen active justify-center p-8">
        <h1 class="text-5xl font-black text-blue-600 italic text-center mb-10">FhotosTube</h1>
        <input type="text" id="logUser" placeholder="Username" class="auth-input">
        <input type="password" id="logPass" placeholder="Password" class="auth-input">
        <button id="btnEntrar" class="btn-blue mb-6">ENTRAR</button>
        <p class="text-center text-sm text-gray-500">Novo aqui? <span onclick="go('registerScreen')" class="text-blue-500 font-bold cursor-pointer">Crie sua conta</span></p>
    </div>

    <div id="registerScreen" class="screen justify-center p-8">
        <h1 class="text-4xl font-black text-center mb-8">Cadastro</h1>
        <input type="text" id="regUser" placeholder="Escolha um Username" class="auth-input">
        <input type="password" id="regPass" placeholder="Crie uma Senha" class="auth-input">
        <button id="btnNextSetup" class="btn-blue mb-4">PRÓXIMO: CRIAR PERFIL</button>
        <p onclick="go('loginScreen')" class="text-center text-gray-500 cursor-pointer">Já tenho conta</p>
    </div>

    <div id="setupScreen" class="screen justify-center p-8">
        <h2 class="text-2xl font-bold text-center mb-6">Monte seu Perfil</h2>
        <div class="flex flex-col items-center mb-6">
            <div class="relative w-32 h-32 mb-4">
                <img id="setupPreview" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-full h-full rounded-full object-cover border-4 border-blue-600">
                <label class="absolute bottom-0 right-0 bg-blue-600 p-2 rounded-full cursor-pointer">
                    <i class="fa-solid fa-camera text-white"></i>
                    <input type="file" id="setupFile" accept="image/*" class="hidden">
                </label>
            </div>
            <p class="text-xs text-gray-400">Clique para mudar a foto</p>
        </div>
        <input type="text" id="setupNickDisplay" placeholder="Seu Nome Público" class="auth-input">
        <textarea id="setupBio" placeholder="Sua bio..." class="auth-input h-20"></textarea>
        <button id="btnFinish" class="btn-blue">CONCLUIR E ENTRAR</button>
    </div>

    <div id="feedScreen" class="screen">
        <header class="p-4 border-b border-gray-800 flex justify-between items-center sticky top-0 bg-black z-50">
            <span class="text-2xl font-black italic text-blue-600">FhotosTube</span>
        </header>
        <div id="feedList" class="flex-1 overflow-y-auto pb-20 hide-scroll"></div>
    </div>

    <div id="profileScreen" class="screen">
        <div class="p-6 border-b border-gray-900">
            <div class="flex items-center gap-6 mb-4">
                <img id="pPic" src="" class="w-24 h-24 rounded-full object-cover border-2 border-blue-600">
                <div>
                    <h2 id="pNick" class="text-2xl font-bold"></h2>
                    <p id="pBio" class="text-gray-400 text-sm"></p>
                </div>
            </div>
            <div id="pActions" class="w-full"></div>
        </div>
        <div id="pGrid" class="grid-posts"></div>
    </div>

    <div id="postScreen" class="screen p-8 justify-center">
        <h2 class="text-2xl font-bold mb-4">Novo Post</h2>
        <div id="uploadPreviewArea" class="mb-4 hidden">
             </div>
        <label class="btn-blue text-center mb-4 block cursor-pointer">
            Selecionar Foto ou Vídeo
            <input type="file" id="fileIn" accept="image/*,video/*" class="hidden">
        </label>
        <textarea id="postCap" placeholder="Legenda..." class="auth-input h-24"></textarea>
        <button id="btnPostar" class="btn-blue">PUBLICAR NO FEED</button>
        <button onclick="go('feedScreen')" class="w-full mt-4 text-gray-500">Cancelar</button>
    </div>

    <nav id="navBar" class="hidden">
        <i class="fa-solid fa-house text-xl cursor-pointer" onclick="go('feedScreen')"></i>
        <i class="fa-solid fa-square-plus text-2xl cursor-pointer" onclick="go('postScreen')"></i>
        <i class="fa-solid fa-user text-xl cursor-pointer" id="btnMyProfile"></i>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAMHAKVot044psR421B_t-Ht5EmsueVS8A",
        authDomain: "game-dev-space.firebaseapp.com",
        databaseURL: "https://game-dev-space-default-rtdb.firebaseio.com",
        projectId: "game-dev-space",
        storageBucket: "game-dev-space.firebasestorage.app",
        appId: "1:1073185335190:web:ae9ffd88cdf89f53cbdfb7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let user = JSON.parse(localStorage.getItem('ft_user')) || null;
    let tempUserData = {};

    window.go = (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const nav = document.getElementById('navBar');
        if(['loginScreen', 'registerScreen', 'setupScreen'].includes(id)) nav.classList.add('hidden');
        else nav.classList.remove('hidden');
    };

    // --- CADASTRO ---
    document.getElementById('btnNextSetup').onclick = async () => {
        const u = document.getElementById('regUser').value.trim().toLowerCase();
        const p = document.getElementById('regPass').value;
        if(!u || !p) return alert("Preencha!");
        const snap = await get(ref(db, 'users_final/' + u));
        if(snap.exists()) return alert("Já existe!");
        
        tempUserData = { nick: u, pass: p, pic: "https://cdn-icons-png.flaticon.com/512/149/149071.png", display: u, bio: "" };
        go('setupScreen');
    };

    // --- SETUP PERFIL ---
    document.getElementById('setupFile').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            document.getElementById('setupPreview').src = ev.target.result;
            tempUserData.pic = ev.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
    };

    document.getElementById('btnFinish').onclick = async () => {
        tempUserData.display = document.getElementById('setupNickDisplay').value || tempUserData.nick;
        tempUserData.bio = document.getElementById('setupBio').value;
        await set(ref(db, 'users_final/' + tempUserData.nick), tempUserData);
        user = tempUserData;
        localStorage.setItem('ft_user', JSON.stringify(user));
        go('feedScreen');
    };

    // --- LOGIN ---
    document.getElementById('btnEntrar').onclick = async () => {
        const u = document.getElementById('logUser').value.trim().toLowerCase();
        const p = document.getElementById('logPass').value;
        const snap = await get(ref(db, 'users_final/' + u));
        if(snap.exists() && snap.val().pass === p) {
            user = snap.val();
            localStorage.setItem('ft_user', JSON.stringify(user));
            go('feedScreen');
        } else alert("Dados incorretos!");
    };

    // --- POSTAR ---
    document.getElementById('btnPostar').onclick = () => {
        const file = document.getElementById('fileIn').files[0];
        if(!file) return alert("Selecione algo!");
        const reader = new FileReader();
        reader.onload = (e) => {
            const type = file.type.startsWith('video') ? 'video' : 'image';
            push(ref(db, 'posts_final'), {
                author: user.nick,
                pic: user.pic,
                content: e.target.result,
                type: type,
                caption: document.getElementById('postCap').value,
                time: Date.now()
            });
            document.getElementById('postCap').value = "";
            go('feedScreen');
        };
        reader.readAsDataURL(file);
    };

    // --- FEED ---
    onValue(ref(db, 'posts_final'), (snap) => {
        const feed = document.getElementById('feedList');
        feed.innerHTML = "";
        const data = snap.val();
        if(!data) return;
        Object.keys(data).reverse().forEach(id => {
            const p = data[id];
            const media = p.type === 'video' 
                ? `<video src="${p.content}" controls class="w-full"></video>` 
                : `<img src="${p.content}" class="w-full">`;
            feed.innerHTML += `
                <div class="mb-8 border-b border-gray-900 pb-2">
                    <div class="flex items-center gap-2 p-3 cursor-pointer" onclick="openProfile('${p.author}')">
                        <img src="${p.pic}" class="w-10 h-10 rounded-full object-cover border border-blue-600">
                        <span class="font-bold">${p.author}</span>
                    </div>
                    ${media}
                    <div class="p-3">
                        <p class="text-sm"><b>${p.author}</b> ${p.caption || ""}</p>
                    </div>
                </div>`;
        });
    });

    // --- PERFIL ---
    window.openProfile = async (nick) => {
        const snap = await get(ref(db, 'users_final/' + nick));
        if(!snap.exists()) return;
        const u = snap.val();
        document.getElementById('pNick').innerText = u.display || u.nick;
        document.getElementById('pPic').src = u.pic;
        document.getElementById('pBio').innerText = u.bio || "";
        
        const actions = document.getElementById('pActions');
        actions.innerHTML = u.nick === user.nick 
            ? `<button onclick="localStorage.clear(); location.reload();" class="w-full bg-zinc-900 py-2 rounded-lg font-bold">Sair</button>`
            : `<button class="w-full bg-blue-600 py-2 rounded-lg font-bold">Mensagem</button>`;

        const grid = document.getElementById('pGrid');
        grid.innerHTML = "";
        const pSnap = await get(ref(db, 'posts_final'));
        if(pSnap.exists()){
            Object.values(pSnap.val()).forEach(p => {
                if(p.author === nick) {
                    const m = p.type === 'video' ? `<video src="${p.content}"></video>` : `<img src="${p.content}">`;
                    grid.innerHTML += `<div class="grid-item">${m}</div>`;
                }
            });
        }
        go('profileScreen');
    };

    document.getElementById('btnMyProfile').onclick = () => openProfile(user.nick);

    if(user) go('feedScreen');
</script>
</body>
</html>
