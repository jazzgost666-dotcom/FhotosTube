<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FhotosTube Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; display: flex; justify-content: center; min-height: 100vh; margin: 0; overflow-y: scroll; }
        .app-container { width: 100%; max-width: 480px; background: #000; min-height: 100vh; position: relative; border-left: 1px solid #1a1a1a; border-right: 1px solid #1a1a1a; display: flex; flex-direction: column; }
        .screen { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.3s ease; }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .auth-input { background: #121212; border: 1px solid #333; color: white; padding: 16px; border-radius: 12px; width: 100%; margin-bottom: 12px; outline: none; }
        .btn-primary { background: #2563eb; color: white; font-weight: 700; padding: 14px; border-radius: 12px; width: 100%; transition: 0.2s; }
        .grid-posts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding-bottom: 80px; }
        .grid-item { aspect-ratio: 1/1; background: #111; cursor: pointer; overflow: hidden; position: relative; border: 0.5px solid #000; }
        .grid-item img, .grid-item video { width: 100%; height: 100%; object-fit: cover; }
        nav { position: fixed; bottom: 0; width: 100%; max-width: 480px; background: #000; border-top: 1px solid #1a1a1a; height: 65px; display: flex; justify-content: space-around; align-items: center; z-index: 999; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="loginScreen" class="screen active justify-center p-8">
        <h1 class="text-5xl font-black text-blue-600 italic text-center mb-10">FhotosTube</h1>
        <input type="text" id="logUser" placeholder="Username" class="auth-input">
        <input type="password" id="logPass" placeholder="Password" class="auth-input">
        <button id="btnEntrar" class="btn-primary mb-6">ENTRAR</button>
        <p class="text-center text-sm text-gray-500">Não tem conta? <span onclick="go('registerScreen')" class="text-blue-500 font-bold cursor-pointer">Crie já!</span></p>
    </div>

    <div id="registerScreen" class="screen justify-center p-8">
        <h1 class="text-4xl font-black text-center mb-8">Nova Conta</h1>
        <input type="text" id="regUser" placeholder="Username" class="auth-input">
        <input type="email" id="regGmail" placeholder="Email (@gmail.com)" class="auth-input">
        <input type="password" id="regPass" placeholder="Password" class="auth-input">
        <button id="btnCriar" class="btn-primary mb-6">CADASTRAR</button>
        <button onclick="go('loginScreen')" class="text-gray-500 w-full text-center">Voltar</button>
    </div>

    <div id="feedScreen" class="screen">
        <header class="h-16 border-b border-gray-800 flex justify-between items-center px-4 sticky top-0 bg-black/90 backdrop-blur-md z-50">
            <span class="text-2xl font-black italic text-blue-600">FhotosTube</span>
            <i class="fa-regular fa-paper-plane text-xl"></i>
        </header>
        <div id="feedList" class="flex-1 overflow-y-auto hide-scroll pb-24"></div>
    </div>

    <div id="profileScreen" class="screen">
        <header class="h-14 border-b border-gray-800 flex items-center px-4 gap-4">
            <i class="fa-solid fa-arrow-left cursor-pointer" onclick="go('feedScreen')"></i>
            <span id="pNickTitle" class="font-bold text-lg"></span>
        </header>
        <div class="p-5">
            <div class="flex items-center justify-between mb-6">
                <img id="pPic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-24 h-24 rounded-full object-cover border-4 border-black ring-2 ring-gray-800">
                <div class="flex gap-6 text-center">
                    <div><b id="cPosts" class="block text-xl">0</b><span class="text-xs text-gray-500 uppercase">Posts</span></div>
                    <div><b id="cFollows" class="block text-xl">0</b><span class="text-xs text-gray-500 uppercase">Fãs</span></div>
                </div>
            </div>
            <div id="pActions" class="mb-4"></div>
        </div>
        <div id="pGrid" class="grid-posts"></div>
    </div>

    <div id="postScreen" class="screen p-6 justify-center">
        <h2 class="text-2xl font-bold mb-6 text-center">Novo Post</h2>
        <input type="file" id="fileIn" accept="image/*,video/*" class="mb-4">
        <textarea id="postCap" placeholder="Legenda..." class="auth-input h-24 resize-none"></textarea>
        <button id="btnPostar" class="btn-primary">PUBLICAR</button>
        <button onclick="go('feedScreen')" class="text-gray-500 mt-4">Cancelar</button>
    </div>

    <div id="chatScreen" class="screen">
        <header class="h-16 border-b border-gray-800 flex items-center px-4 gap-4 bg-black sticky top-0 z-50">
            <i class="fa-solid fa-arrow-left" onclick="go('feedScreen')"></i>
            <span id="chatTitle" class="font-bold">Chat</span>
        </header>
        <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-3 pb-20"></div>
        <div class="p-3 border-t border-gray-800 flex gap-2 fixed bottom-0 w-full max-w-[480px] bg-black">
            <input type="text" id="chatMsg" class="auth-input mb-0 flex-1" placeholder="Mensagem...">
            <button id="btnSend" class="text-blue-500 font-bold px-3">Enviar</button>
        </div>
    </div>

    <nav id="navBar" class="hidden">
        <i class="fa-solid fa-house text-2xl" onclick="go('feedScreen')"></i>
        <i class="fa-solid fa-square-plus text-3xl" onclick="go('postScreen')"></i>
        <i class="fa-solid fa-user text-2xl" id="btnMyProfile"></i>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAMHAKVot044psR421B_t-Ht5EmsueVS8A",
        authDomain: "game-dev-space.firebaseapp.com",
        databaseURL: "https://game-dev-space-default-rtdb.firebaseio.com",
        projectId: "game-dev-space",
        storageBucket: "game-dev-space.firebasestorage.app",
        appId: "1:1073185335190:web:ae9ffd88cdf89f53cbdfb7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let user = JSON.parse(localStorage.getItem('ft_user')) || null;

    window.go = (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const nav = document.getElementById('navBar');
        if(['loginScreen', 'registerScreen', 'chatScreen'].includes(id)) nav.classList.add('hidden');
        else nav.classList.remove('hidden');
    };

    // CADASTRO
    document.getElementById('btnCriar').onclick = async () => {
        const u = document.getElementById('regUser').value.trim().toLowerCase();
        const g = document.getElementById('regGmail').value.trim();
        const p = document.getElementById('regPass').value;
        if(!u || !g || !p) return alert("Preencha tudo!");
        
        const snap = await get(ref(db, 'users_v4/' + u));
        if(snap.exists()) return alert("Username já existe!");

        await set(ref(db, 'users_v4/' + u), { nick: u, gmail: g, pass: p, pic: "https://cdn-icons-png.flaticon.com/512/149/149071.png" });
        alert("Conta Criada!");
        go('loginScreen');
    };

    // LOGIN
    document.getElementById('btnEntrar').onclick = async () => {
        const u = document.getElementById('logUser').value.trim().toLowerCase();
        const p = document.getElementById('logPass').value;
        const snap = await get(ref(db, 'users_v4/' + u));
        if(snap.exists() && snap.val().pass === p) {
            user = snap.val();
            localStorage.setItem('ft_user', JSON.stringify(user));
            go('feedScreen');
        } else alert("Usuário ou Senha incorretos!");
    };

    // POSTAR
    document.getElementById('btnPostar').onclick = () => {
        const file = document.getElementById('fileIn').files[0];
        const cap = document.getElementById('postCap').value;
        if(!file) return alert("Escolha uma foto ou vídeo!");

        const reader = new FileReader();
        reader.onload = (e) => {
            const type = file.type.startsWith('video') ? 'video' : 'image';
            push(ref(db, 'posts_v4'), {
                author: user.nick,
                pic: user.pic,
                content: e.target.result,
                type: type,
                caption: cap,
                time: Date.now()
            }).then(() => {
                document.getElementById('fileIn').value = "";
                document.getElementById('postCap').value = "";
                go('feedScreen');
            });
        };
        reader.readAsDataURL(file);
    };

    // FEED
    onValue(ref(db, 'posts_v4'), (snap) => {
        const feed = document.getElementById('feedList');
        feed.innerHTML = "";
        const data = snap.val();
        if(!data) return;
        Object.keys(data).reverse().forEach(id => {
            const p = data[id];
            const media = p.type === 'video' 
                ? `<video src="${p.content}" controls class="w-full bg-black"></video>` 
                : `<img src="${p.content}" class="w-full">`;
            feed.innerHTML += `
                <div class="mb-6 border-b border-gray-900 pb-2">
                    <div class="flex items-center gap-2 p-3 cursor-pointer" onclick="openProfile('${p.author}')">
                        <img src="${p.pic}" class="w-8 h-8 rounded-full object-cover">
                        <span class="font-bold text-sm">${p.author}</span>
                    </div>
                    ${media}
                    <div class="p-3">
                        <p class="text-sm"><b>${p.author}</b> ${p.caption || ''}</p>
                    </div>
                </div>`;
        });
    });

    // PERFIL
    window.openProfile = async (nick) => {
        const snap = await get(ref(db, 'users_v4/' + nick));
        const u = snap.val();
        if(!u) return;

        document.getElementById('pNickTitle').innerText = u.nick;
        document.getElementById('pPic').src = u.pic;
        
        const actions = document.getElementById('pActions');
        actions.innerHTML = u.nick === user.nick 
            ? `<button onclick="localStorage.clear(); location.reload()" class="w-full bg-zinc-900 py-2 rounded font-bold text-sm">Sair da Conta</button>`
            : `<button onclick="openChat('${u.nick}')" class="w-full bg-blue-600 py-2 rounded font-bold text-sm">Mensagem</button>`;

        const grid = document.getElementById('pGrid');
        grid.innerHTML = "";
        const pSnap = await get(ref(db, 'posts_v4'));
        let count = 0;
        if(pSnap.exists()){
            Object.values(pSnap.val()).forEach(p => {
                if(p.author === nick) {
                    count++;
                    const media = p.type === 'video' ? `<video src="${p.content}"></video>` : `<img src="${p.content}">`;
                    grid.innerHTML += `<div class="grid-item">${media}</div>`;
                }
            });
        }
        document.getElementById('cPosts').innerText = count;
        go('profileScreen');
    };

    // CHAT
    window.openChat = (nick) => {
        document.getElementById('chatTitle').innerText = "Chat com " + nick;
        go('chatScreen');
        const chatId = [user.nick, nick].sort().join('_');
        onValue(ref(db, 'chats_v4/' + chatId), (s) => {
            const box = document.getElementById('chatBox');
            box.innerHTML = "";
            const msgs = s.val();
            if(msgs) Object.values(msgs).forEach(m => {
                const isMe = m.sender === user.nick;
                box.innerHTML += `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <span class="${isMe ? 'bg-blue-600' : 'bg-zinc-800'} px-4 py-2 rounded-2xl text-sm max-w-[80%]">${m.text}</span>
                </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
        document.getElementById('btnSend').onclick = () => {
            const inp = document.getElementById('chatMsg');
            if(!inp.value) return;
            push(ref(db, 'chats_v4/' + chatId), { sender: user.nick, text: inp.value });
            inp.value = "";
        };
    };

    document.getElementById('btnMyProfile').onclick = () => openProfile(user.nick);
    if(user) go('feedScreen');
</script>
</body>
</html>
