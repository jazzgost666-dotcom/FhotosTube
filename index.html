<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FhotosTube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 480px; background: #000; min-height: 100vh; position: relative; border-left: 1px solid #1a1a1a; border-right: 1px solid #1a1a1a; display: flex; flex-direction: column; }
        .screen { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.2s ease; }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .auth-input { background: #121212; border: 1px solid #333; color: white; padding: 15px; border-radius: 12px; width: 100%; margin-bottom: 12px; outline: none; }
        .btn-blue { background: #2563eb; color: white; font-weight: bold; padding: 14px; border-radius: 12px; width: 100%; transition: 0.3s; }
        .btn-blue:active { transform: scale(0.95); }
        .grid-posts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
        .grid-item { aspect-ratio: 1/1; background: #111; cursor: pointer; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; }
        nav { position: fixed; bottom: 0; width: 100%; max-width: 480px; background: #000; border-top: 1px solid #1a1a1a; height: 60px; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="loginScreen" class="screen active justify-center p-8">
        <h1 class="text-5xl font-black text-blue-600 italic text-center mb-2">FhotosTube</h1>
        <p class="text-center text-gray-400 mb-8">Olá bem-vindo(a) denovo!</p>
        <input type="text" id="logUser" placeholder="Username" class="auth-input">
        <input type="password" id="logPass" placeholder="Password" class="auth-input">
        <button id="btnEntrar" class="btn-blue mb-6">ENTRAR</button>
        <p class="text-center text-sm text-gray-500">Não tem uma conta? <span onclick="go('registerScreen')" class="text-blue-500 font-bold cursor-pointer">crie já! CLIQUE AQUI</span></p>
    </div>

    <div id="registerScreen" class="screen justify-center p-8">
        <h1 class="text-4xl font-black text-white italic text-center mb-8">FhotosTube</h1>
        <input type="text" id="regUser" placeholder="Username" class="auth-input">
        <input type="email" id="regGmail" placeholder="Gmail (@gmail.com)" class="auth-input">
        <input type="password" id="regPass" placeholder="Password" class="auth-input">
        <button id="btnCriar" class="btn-blue mb-4">CRIAR CONTA</button>
        <p onclick="go('loginScreen')" class="text-center text-gray-500 cursor-pointer">Voltar para Login</p>
    </div>

    <div id="feedScreen" class="screen">
        <header class="p-4 border-b border-gray-800 flex justify-between items-center bg-black sticky top-0 z-50">
            <span class="text-2xl font-black italic text-blue-600">FhotosTube</span>
        </header>
        <div id="feedList" class="flex-1 overflow-y-auto hide-scroll pb-20"></div>
    </div>

    <div id="profileScreen" class="screen">
        <header class="p-4 border-b border-gray-800 flex justify-between items-center bg-black">
            <span id="pNickTitle" class="font-bold"></span>
            <i id="settingsBtn" class="fa-solid fa-gear text-xl cursor-pointer hidden" onclick="go('settingsScreen')"></i>
        </header>
        <div class="p-5">
            <div class="flex items-center gap-6 mb-6">
                <img id="pPic" src="" class="w-20 h-20 rounded-full object-cover border-2 border-blue-600">
                <div class="flex gap-4 text-center">
                    <div><b id="cPosts" class="block">0</b><span class="text-xs text-gray-500">Posts</span></div>
                    <div><b id="cFollows" class="block">0</b><span class="text-xs text-gray-500">Fãs</span></div>
                </div>
            </div>
            <div id="pActions" class="flex gap-2 mb-4"></div>
        </div>
        <div id="pGrid" class="grid-posts"></div>
    </div>

    <div id="settingsScreen" class="screen p-6">
        <h2 class="text-xl font-bold mb-6">Configurações</h2>
        <p class="text-sm text-gray-400 mb-2">Alterar Foto de Perfil (URL):</p>
        <input type="text" id="newPicUrl" class="auth-input" placeholder="http://imagem.jpg">
        <button id="btnSaveConfig" class="btn-blue mb-4">SALVAR</button>
        <button onclick="logout()" class="w-full text-red-500 font-bold border border-red-900 py-3 rounded-xl">SAIR DA CONTA</button>
        <button onclick="go('profileScreen')" class="w-full mt-4 text-gray-500">Voltar</button>
    </div>

    <div id="postScreen" class="screen p-6">
        <h2 class="text-xl font-bold mb-6">Novo Post</h2>
        <input type="file" id="fileIn" class="mb-4">
        <textarea id="postCap" placeholder="Legenda..." class="auth-input h-24"></textarea>
        <button id="btnPostar" class="btn-blue">PUBLICAR AGORA</button>
    </div>

    <div id="chatScreen" class="screen">
        <header class="p-4 border-b border-gray-800 flex items-center gap-4">
            <i class="fa-solid fa-arrow-left" onclick="go('feedScreen')"></i>
            <span id="chatTitle" class="font-bold">Chat</span>
        </header>
        <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        <div class="p-4 flex gap-2">
            <input type="text" id="chatMsg" class="auth-input mb-0 flex-1" placeholder="Mensagem...">
            <button id="btnSend" class="bg-blue-600 px-6 rounded-xl">></button>
        </div>
    </div>

    <nav id="navBar" class="hidden">
        <i class="fa-solid fa-house text-xl" onclick="go('feedScreen')"></i>
        <i class="fa-solid fa-square-plus text-2xl" onclick="go('postScreen')"></i>
        <i class="fa-solid fa-user text-xl" id="btnMyProfile"></i>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAMHAKVot044psR421B_t-Ht5EmsueVS8A",
        authDomain: "game-dev-space.firebaseapp.com",
        databaseURL: "https://game-dev-space-default-rtdb.firebaseio.com",
        projectId: "game-dev-space",
        storageBucket: "game-dev-space.firebasestorage.app",
        appId: "1:1073185335190:web:ae9ffd88cdf89f53cbdfb7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUser = JSON.parse(localStorage.getItem('ft_session')) || null;
    let viewingUid = null;

    window.go = (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'loginScreen' || id === 'registerScreen') {
            document.getElementById('navBar').classList.add('hidden');
        } else {
            document.getElementById('navBar').classList.remove('hidden');
        }
    };

    // CADASTRO
    document.getElementById('btnCriar').onclick = async () => {
        const u = document.getElementById('regUser').value.trim();
        const g = document.getElementById('regGmail').value.trim();
        const p = document.getElementById('regPass').value;

        if(!u || !g.endsWith('@gmail.com') || !p) return alert("Dados inválidos!");
        
        const snap = await get(ref(db, 'users/' + u));
        if(snap.exists()) return alert("Usuário já existe!");

        const userData = { nick: u, gmail: g, pass: p, pic: "https://cdn-icons-png.flaticon.com/512/149/149071.png", followers: 0 };
        await set(ref(db, 'users/' + u), userData);
        alert("Conta criada!");
        go('loginScreen');
    };

    // LOGIN
    document.getElementById('btnEntrar').onclick = async () => {
        const u = document.getElementById('logUser').value.trim();
        const p = document.getElementById('logPass').value;

        const snap = await get(ref(db, 'users/' + u));
        if(snap.exists() && snap.val().pass === p) {
            currentUser = snap.val();
            localStorage.setItem('ft_session', JSON.stringify(currentUser));
            go('feedScreen');
        } else {
            alert("Erro no Login!");
        }
    };

    window.logout = () => {
        localStorage.removeItem('ft_session');
        location.reload();
    };

    // POSTAR
    document.getElementById('btnPostar').onclick = () => {
        const file = document.getElementById('fileIn').files[0];
        const cap = document.getElementById('postCap').value;
        if(!file) return alert("Selecione uma foto!");

        const reader = new FileReader();
        reader.onload = (e) => {
            push(ref(db, 'posts'), {
                author: currentUser.nick,
                pic: currentUser.pic,
                img: e.target.result,
                cap: cap,
                likes: 0,
                time: Date.now()
            });
            go('feedScreen');
        };
        reader.readAsDataURL(file);
    };

    // CARREGAR FEED
    onValue(ref(db, 'posts'), (snap) => {
        const list = document.getElementById('feedList');
        list.innerHTML = "";
        const data = snap.val();
        if(!data) return;
        Object.keys(data).reverse().forEach(k => {
            const p = data[k];
            list.innerHTML += `
                <div class="mb-4 border-b border-gray-900 pb-4">
                    <div class="flex items-center gap-2 p-3 cursor-pointer" onclick="openProfile('${p.author}')">
                        <img src="${p.pic}" class="w-8 h-8 rounded-full">
                        <span class="font-bold text-sm">${p.author}</span>
                    </div>
                    <img src="${p.img}" class="w-full max-h-96 object-cover">
                    <div class="p-3">
                        <p class="text-sm"><b>${p.author}</b> ${p.cap}</p>
                    </div>
                </div>`;
        });
    });

    // PERFIL
    window.openProfile = async (nick) => {
        const snap = await get(ref(db, 'users/' + nick));
        const u = snap.val();
        viewingUid = nick;

        document.getElementById('pNickTitle').innerText = u.nick;
        document.getElementById('pPic').src = u.pic;
        document.getElementById('settingsBtn').classList.toggle('hidden', u.nick !== currentUser.nick);
        
        const actions = document.getElementById('pActions');
        actions.innerHTML = "";
        if(u.nick !== currentUser.nick) {
            actions.innerHTML = `
                <button class="btn-blue flex-1 py-1" onclick="alert('Seguindo!')">Seguir</button>
                <button class="bg-zinc-800 text-white flex-1 rounded-lg py-1" onclick="openChat('${u.nick}')">Chat</button>
            `;
        }

        const grid = document.getElementById('pGrid');
        grid.innerHTML = "";
        const pSnap = await get(ref(db, 'posts'));
        if(pSnap.exists()) {
            let count = 0;
            Object.values(pSnap.val()).forEach(p => {
                if(p.author === nick) {
                    grid.innerHTML += `<div class="grid-item"><img src="${p.img}"></div>`;
                    count++;
                }
            });
            document.getElementById('cPosts').innerText = count;
        }

        go('profileScreen');
    };

    // CHAT
    window.openChat = (nick) => {
        document.getElementById('chatTitle').innerText = nick;
        go('chatScreen');
        const chatId = [currentUser.nick, nick].sort().join('_');
        onValue(ref(db, 'chats/' + chatId), (s) => {
            const box = document.getElementById('chatBox');
            box.innerHTML = "";
            const msgs = s.val();
            if(msgs) Object.values(msgs).forEach(m => {
                const isMe = m.sender === currentUser.nick;
                box.innerHTML += `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <span class="${isMe ? 'bg-blue-600' : 'bg-zinc-800'} px-4 py-2 rounded-xl text-sm">${m.text}</span>
                </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
        document.getElementById('btnSend').onclick = () => {
            const t = document.getElementById('chatMsg').value;
            if(!t) return;
            push(ref(db, 'chats/' + chatId), { sender: currentUser.nick, text: t });
            document.getElementById('chatMsg').value = "";
        };
    };

    document.getElementById('btnMyProfile').onclick = () => openProfile(currentUser.nick);
    document.getElementById('btnSaveConfig').onclick = async () => {
        const url = document.getElementById('newPicUrl').value;
        if(url) {
            await set(ref(db, `users/${currentUser.nick}/pic`), url);
            currentUser.pic = url;
            localStorage.setItem('ft_session', JSON.stringify(currentUser));
            alert("Perfil Atualizado!");
            go('profileScreen');
        }
    };

    if(currentUser) go('feedScreen');

</script>
</body>
</html>
